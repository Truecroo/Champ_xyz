<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Selfie Cubes</title>
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />

  <!-- jQuery (–Ω—É–∂–Ω–æ –¥–ª—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤) -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>

  <!-- THREE.js (–∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/examples/js/controls/OrbitControls.js"></script>

  <!-- TFJS + MediaPipe FaceMesh + ml5 (FaceMesh) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.18.0/dist/tf.min.js"></script>
  <script src="https://unpkg.com/@mediapipe/face_mesh@0.4/face_mesh.js"></script>
  <script src="https://unpkg.com/ml5@0.12.2/dist/ml5.min.js"></script>

  <!-- –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ (–∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ; p5/isMobile –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω—ã, –Ω–æ –æ—Å—Ç–∞–≤–ª—é) -->
  <script src="https://cdn.jsdelivr.net/npm/ismobilejs@1/dist/isMobile.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/p5@1.0.0/lib/p5.min.js"></script>

  <link rel="stylesheet" href="selfie.css" />
  <style>
    /* –ü–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞, –µ—Å–ª–∏ –Ω–µ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ CSS */
    body { margin:0; background:#000; color:#fff; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif; }
    #permission-screen { position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:16px; background:#000; z-index:10; }
    #button_loader, .downloadButton, .questionButton { padding:10px 16px; border:1px solid #fff; background:transparent; color:#fff; border-radius:8px; }
    #container { position:fixed; inset:0; display:none; }
    #about { position:fixed; right:12px; bottom:12px; }
    #aboutText { display:none; position:fixed; right:12px; bottom:60px; width:240px; background:rgba(0,0,0,.7); padding:12px; border-radius:8px; }
    #download_div { position:fixed; left:12px; bottom:12px; display:none; }
    #discription { position:fixed; top:12px; left:12px; }
    #frame { position:fixed; top:12px; right:12px; display:none; }
    #loading-screen { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:#000; z-index:9; }
    #loading_gif { width:120px; height:120px; opacity:.8; }
    video { opacity:0; width:0; height:0; position:absolute; left:-9999px; }
    canvas { image-rendering: auto; }
  </style>
</head>

<body id="body_ID">

  <div id="loading-screen" class="wrapper">
    <img id="loading_gif" src="Loading_G.gif" alt="loading">
  </div>

  <section id="permission-screen">
    <div id="loader">
      Please allow camera access to experience this website.<br>Your video will not be stored anywhere.
    </div>
    <button id="button_loader">Continue</button>
  </section>

  <div id="container"></div>

  <!-- –ö–∞–Ω–≤–∞—Å—ã-–∏—Å—Ç–æ—á–Ω–∏–∫–∏ –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä (—É–≤–µ–ª–∏—á–µ–Ω—ã –¥–ª—è —á–µ—Ç–∫–æ—Å—Ç–∏ –Ω–∞ —Ä–µ—Ç–∏–Ω–µ) -->
  <canvas id="canvas04" width="512" height="512" style="display:none"></canvas>  <!-- nose -->
  <canvas id="canvas01" width="512" height="512" style="display:none"></canvas>  <!-- right eye -->
  <canvas id="canvas02" width="512" height="256" style="display:none"></canvas>  <!-- mouth -->
  <canvas id="Mycanvas" width="512" height="512" style="display:none"></canvas>  <!-- left eye -->

  <video autoplay muted playsinline id="video" width="480" height="640"></video>

  <div id="discription">
    <p class="intro">Tap to switch layout ‚Ä¢ Swipe to change plan</p>
  </div>

  <div id="frame">
    <p class="desktop_view">This website is best on a phone.</p>
  </div>

  <div id="about">
    <div id="aboutText">
      <p class="explain">
        Take a Selfie ‚Äî 3D rendering + face detection. Click & drag to find your angle.
      </p>
      <p class="credits">
        Technologies: <a href="https://threejs.org/">Three.js</a> & <a href="https://learn.ml5js.org/#/reference/facemesh">ml5 FaceMesh</a><br><br>
        Rebuilt by Yegor‚Äôs dev ü§ù
      </p>
    </div>
    <button class="questionButton" id="aboutButton">Info</button>
  </div>

  <div id="download_div">
    <button class="downloadButton" id="download">Capture</button>
  </div>

<script>
  // =======================
  // Globals & DOM
  // =======================
  const video = document.getElementById("video");

  const nose_canvas  = document.getElementById("canvas04"); const ctxNose  = nose_canvas.getContext("2d");
  const left_canvas  = document.getElementById("Mycanvas"); const ctxLEye  = left_canvas.getContext("2d");
  const right_canvas = document.getElementById("canvas01"); const ctxREye  = right_canvas.getContext("2d");
  const mouth_canvas = document.getElementById("canvas02"); const ctxMouth = mouth_canvas.getContext("2d");

  let scene, renderer, controls;
  let camera, orthoCamera, activeCamera, isOrtho = false;

  let cube01, cube02, cube03, cube04; // nose, left eye, right eye, mouth
  const FIXED_Z = 0;

  // –ø—Ä–µ—Å–µ—Ç—ã –∫–æ–º–ø–æ–∑–∏—Ü–∏–π (x, y) ‚Äî –º–æ–∂–Ω–æ –¥–æ–ø–æ–ª–Ω—è—Ç—å
  const presets = [
    { nose:[  30,-130], lEye:[-30, -30], rEye:[ 50,  80], mouth:[-40, 100] },
    { nose:[   0, -90], lEye:[-60, -40], rEye:[ 60, -40], mouth:[  0, 110] },
    { nose:[ -20,-120], lEye:[-70,  10], rEye:[ 40,  40], mouth:[-10, 120] },
  ];
  let presetIndex = 0;

  // bbox –∏–∑ FaceMesh (–æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –≤ gotFaces)
  window._bbNose = null;
  window._bbLEye = null;
  window._bbREye = null;
  window._bbMouth = null;

  // –∂–µ—Å—Ç—ã
  let drag = false, touchStartX = 0, touchStartY = 0;

  // =======================
  // UI buttons
  // =======================
  $("#download").on("click", function(){
    const dataURL = renderer.domElement.toDataURL("image/png");
    const link = document.createElement("a");
    link.download = "selfie.png";
    link.href = dataURL;
    link.target = "_blank";
    link.click();
  });

  $("#aboutButton").on("click", function(){
    $("#aboutText").fadeToggle('fast');
    $("#aboutButton").text(($("#aboutButton").text() === 'Info') ? 'Close' : 'Info').fadeIn();
  });

  $("#container").on('touchstart mousedown', function(){
    $("#discription").fadeOut('fast');
  });
  $("#discription").on('touchstart mousedown', function(){
    $("#discription").fadeOut('fast');
  });

  // =======================
  // Camera permission & FaceMesh start
  // =======================
  let faceMesh;
  let firstPredictionCame = false;

  $("#button_loader").on("click", async function(){
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
      alert("Camera is not available in this browser.");
      return;
    }
    $("#permission-screen").fadeOut('slow');
    $("#loading-screen").show();

    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: false });
      video.srcObject = stream;
      await video.play();

      // —Ç–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –≤–∏–¥–µ–æ —Ä–µ–∞–ª—å–Ω–æ –∏–≥—Ä–∞–µ—Ç ‚Äî —Å—Ç–∞—Ä—Ç—É–µ–º FaceMesh
      faceMesh = ml5.faceMesh(video, () => console.log("facemesh ready"));
      faceMesh.on("predict", gotFaces);

      // –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ü–µ–Ω—É/–∫–Ω–æ–ø–∫–∏ —Å—Ä–∞–∑—É (–ø—Ä—è—Ç–∞—Ç—å –ª–æ–∞–¥–µ—Ä ‚Äî –ø—Ä–∏ –ø–µ—Ä–≤–æ–º predict)
      $("#container").fadeIn('slow');
      $("#download_div").fadeIn('slow');
      $("#aboutButton").fadeIn('slow');
    } catch (e) {
      console.error(e);
      alert("Camera permission was denied.");
    }
  });

  // =======================
  // Face landmarks ‚Üí bboxes
  // =======================
  function gotFaces(results) {
    if (!results || results.length === 0) return;

    if (!firstPredictionCame) {
      firstPredictionCame = true;
      $("#loading-screen").fadeOut('fast');
    }

    const pts = results[0].scaledMesh; // 468 —Ç–æ—á–µ–∫

    // –ù–∞–±–æ—Ä—ã –∏–Ω–¥–µ–∫—Å–æ–≤ –∫–æ–Ω—Ç—É—Ä–æ–≤
    const leftEyeIdx = [33, 133, 160, 159, 158, 157, 173];
    const rightEyeIdx= [362, 263, 387, 386, 385, 384, 398];
    const noseIdx    = [1, 6, 197, 195, 5, 4, 45];
    const mouthIdx   = [78, 95, 88, 178, 87, 14, 317, 308, 324];

    function bbox(idxs) {
      let minX=Infinity, minY=Infinity, maxX=-Infinity, maxY=-Infinity;
      for (const i of idxs) {
        const p = pts[i];
        if (!p) continue;
        const x = p[0], y = p[1];
        if (x < minX) minX = x; if (y < minY) minY = y;
        if (x > maxX) maxX = x; if (y > maxY) maxY = y;
      }
      return { x:minX, y:minY, w:Math.max(1, maxX-minX), h:Math.max(1, maxY-minY) };
    }
    function pad(b, p=10){ return { x:b.x-p, y:b.y-p, w:b.w+2*p, h:b.h+2*p }; }

    window._bbNose  = pad(bbox(noseIdx), 10);
    window._bbLEye  = pad(bbox(leftEyeIdx), 10);
    window._bbREye  = pad(bbox(rightEyeIdx), 10);
    window._bbMouth = pad(bbox(mouthIdx), 12);
  }

  // =======================
  // Three.js setup
  // =======================
  const WIDTH = window.innerWidth;
  const HEIGHT = window.innerHeight;
  const VIEW_ANGLE = 35, ASPECT = WIDTH/HEIGHT, NEAR = 0.1, FAR = 2000;

  initThree();
  animate();

  function initThree() {
    scene = new THREE.Scene();
    scene.fog = new THREE.Fog(0xFFFFFF, 1, 25000);

    renderer = new THREE.WebGLRenderer({ antialias:true, preserveDrawingBuffer:true });
    renderer.setPixelRatio(window.devicePixelRatio || 1);
    renderer.setSize(WIDTH, HEIGHT);
    renderer.setClearColor('#000000');
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

    document.getElementById('container').appendChild(renderer.domElement);

    // –∫–∞–º–µ—Ä—ã: –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–∞ + –æ—Ä—Ç–æ
    camera = new THREE.PerspectiveCamera(VIEW_ANGLE, ASPECT, NEAR, FAR);
    camera.position.set(0, 0, 281);

    const frustumSize = 400;
    orthoCamera = new THREE.OrthographicCamera(
      -frustumSize*ASPECT/2, frustumSize*ASPECT/2,
       frustumSize/2, -frustumSize/2,
       NEAR, FAR
    );
    orthoCamera.position.set(0,0,281);

    activeCamera = camera;

    controls = new THREE.OrbitControls(activeCamera, renderer.domElement);
    controls.enablePan = false;
    controls.enableZoom = false;
    controls.enableRotate = false; // —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–æ–º –¥–µ–ª–∞–µ–º —Ç–æ–ª—å–∫–æ –∂–µ—Å—Ç–∞–º–∏

    // —Å–≤–µ—Ç
    const hemi = new THREE.HemisphereLight(0xffffff, 0xffffff, 0.8);
    hemi.position.set(100, 500, 0);
    scene.add(hemi);

    const dir = new THREE.DirectionalLight(0xffffff, 0.4);
    dir.position.set(-3000, 4000, 3000);
    dir.castShadow = true;
    scene.add(dir);

    // —Ç–µ–∫—Å—Ç—É—Ä—ã —Å –∫–∞–Ω–≤–∞—Å–æ–≤
    const texNose  = new THREE.CanvasTexture(nose_canvas);
    const texLEye  = new THREE.CanvasTexture(left_canvas);
    const texREye  = new THREE.CanvasTexture(right_canvas);
    const texMouth = new THREE.CanvasTexture(mouth_canvas);

    const matNose  = new THREE.MeshBasicMaterial({ map: texNose  });
    const matLEye  = new THREE.MeshBasicMaterial({ map: texLEye  });
    const matREye  = new THREE.MeshBasicMaterial({ map: texREye  });
    const matMouth = new THREE.MeshBasicMaterial({ map: texMouth });

    // –≥–µ–æ–º–µ—Ç—Ä–∏–∏ –∫—É–±–æ–≤
    const gNose  = new THREE.BoxGeometry(50, 80, 50);
    const gEye   = new THREE.BoxGeometry(50, 50, 50);
    const gMouth = new THREE.BoxGeometry(100, 45, 45);

    cube01 = new THREE.Mesh(gNose,  matNose);  // nose
    cube02 = new THREE.Mesh(gEye,   matLEye);  // left eye
    cube03 = new THREE.Mesh(gEye,   matREye);  // right eye
    cube04 = new THREE.Mesh(gMouth, matMouth); // mouth

    // –ë–µ–∑ –ø–æ–≤–æ—Ä–æ—Ç–æ–≤, –µ–¥–∏–Ω–∞—è –≥–ª—É–±–∏–Ω–∞
    [cube01, cube02, cube03, cube04].forEach(c => {
      c.rotation.set(0,0,0);
      c.position.z = FIXED_Z;
      scene.add(c);
    });

    applyPreset(presetIndex);

    window.addEventListener('resize', onResize);
  }

  function applyPreset(i) {
    const p = presets[i];
    cube01.position.set(p.nose[0],  p.nose[1],  FIXED_Z);
    cube02.position.set(p.lEye[0],  p.lEye[1],  FIXED_Z);
    cube03.position.set(p.rEye[0],  p.rEye[1],  FIXED_Z);
    cube04.position.set(p.mouth[0], p.mouth[1], FIXED_Z);

    [cube01, cube02, cube03, cube04].forEach(c => c.rotation.set(0,0,0));
  }

  function onResize() {
    const w = window.innerWidth, h = window.innerHeight, aspect = w/h;

    camera.aspect = aspect;
    camera.updateProjectionMatrix();

    const frustumSize = 400;
    orthoCamera.left = -frustumSize*aspect/2;
    orthoCamera.right = frustumSize*aspect/2;
    orthoCamera.top = frustumSize/2;
    orthoCamera.bottom = -frustumSize/2;
    orthoCamera.updateProjectionMatrix();

    renderer.setSize(w, h);
  }

  // =======================
  // Drawing from video ‚Üí canvases
  // =======================
  function safeDraw(dstCtx, b, dw, dh) {
    if (!b || !Number.isFinite(b.x) || !Number.isFinite(b.y)) return;
    // –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ–º –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—É—é —à–∏—Ä–∏–Ω—É/–≤—ã—Å–æ—Ç—É
    const sx = Math.max(0, b.x);
    const sy = Math.max(0, b.y);
    const sw = Math.max(1, b.w);
    const sh = Math.max(1, b.h);
    try {
      dstCtx.drawImage(video, sx, sy, sw, sh, 0, 0, dw, dh);
    } catch(e) {
      // –±—ã–≤–∞–µ—Ç, –∫–æ–≥–¥–∞ —Ä–∞–∑–º–µ—Ä—ã –µ—â—ë –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã
    }
  }

  // =======================
  // Gestures: tap vs swipe
  // =======================
  document.addEventListener('pointerdown', () => { drag = false; }, {passive:true});
  document.addEventListener('pointermove',  () => { drag = true;  }, {passive:true});
  document.addEventListener('pointerup',    (e) => {
    if (!drag) onTap(e);
  }, {passive:true});

  document.addEventListener('touchstart', (e) => {
    drag = false;
    const t = e.touches[0];
    touchStartX = t.clientX; touchStartY = t.clientY;
  }, {passive:true});

  document.addEventListener('touchmove', () => { drag = true; }, {passive:true});

  document.addEventListener('touchend', (e) => {
    if (!drag) { onTap(e.changedTouches ? e.changedTouches[0] : e); return; }
    const dx = (e.changedTouches[0].clientX - touchStartX);
    if (Math.abs(dx) > 40) togglePlan(dx);
  }, {passive:true});

  function onTap(e) {
    // –∏–≥–Ω–æ—Ä –∫–ª–∏–∫–æ–≤ –ø–æ –∫–Ω–æ–ø–∫–∞–º/–∫–Ω–æ–ø–∫–µ Info
    const downloadRect = document.getElementById("download_div").getBoundingClientRect();
    const aboutRect    = document.getElementById("aboutButton").getBoundingClientRect();
    const x = e.pageX || e.clientX, y = e.pageY || e.clientY;

    const inDownload = x >= downloadRect.left-5 && x <= downloadRect.right+5 &&
                       y >= downloadRect.top-5     && y <= downloadRect.bottom+5;
    const inAbout    = x >= aboutRect.left-5    && x <= aboutRect.right+5 &&
                       y >= aboutRect.top-5      && y <= aboutRect.bottom+5;

    if (inDownload || inAbout) return;

    // –ü–µ—Ä–µ–ª–∏—Å—Ç—ã–≤–∞–µ–º –ø—Ä–µ—Å–µ—Ç
    presetIndex = (presetIndex + 1) % presets.length;
    applyPreset(presetIndex);
  }

  function togglePlan(dx) {
    isOrtho = !isOrtho;
    activeCamera = isOrtho ? orthoCamera : camera;

    // –ª—ë–≥–∫–æ–µ –æ—â—É—â–µ–Ω–∏–µ —Å–º–µ–Ω—ã –ø–ª–∞–Ω–∞
    const dir = dx > 0 ? 1 : -1;
    scene.rotation.y += dir * 0.15;
  }

  // =======================
  // Main loop
  // =======================
  function animate() {
    requestAnimationFrame(animate);

    // –æ–±–Ω–æ–≤–ª—è–µ–º –∫–∞—Ä—Ç–∏–Ω–∫–∏ –¥–ª—è —Ç–µ–∫—Å—Ç—É—Ä
    safeDraw(ctxNose,  window._bbNose,  nose_canvas.width,  nose_canvas.height);
    safeDraw(ctxLEye,  window._bbLEye,  left_canvas.width,  left_canvas.height);
    safeDraw(ctxREye,  window._bbREye,  right_canvas.width, right_canvas.height);
    safeDraw(ctxMouth, window._bbMouth, mouth_canvas.width, mouth_canvas.height);

    // –æ–±–Ω–æ–≤–∏—Ç—å –º–∞—Ç–µ—Ä–∏–∞–ª—ã (–∫–∞–∂–¥—ã–π –∫–∞–¥—Ä ‚Äî –¥—ë—à–µ–≤–æ, —Ç.–∫. CanvasTexture)
    if (cube01 && cube01.material && cube01.material.map) cube01.material.map.needsUpdate = true;
    if (cube02 && cube02.material && cube02.material.map) cube02.material.map.needsUpdate = true;
    if (cube03 && cube03.material && cube03.material.map) cube03.material.map.needsUpdate = true;
    if (cube04 && cube04.material && cube04.material.map) cube04.material.map.needsUpdate = true;

    render();
  }

  function render() {
    activeCamera.lookAt(scene.position);
    renderer.render(scene, activeCamera);
  }
</script>
</body>
</html>
